// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  ADMIN
  CUSTOMER_SERVICE // Atencion al cliente
  WAREHOUSE_MANAGER // Encargado de almacen, piezas inventario
  MECHANIC // Mecanico
}

enum StateServie {
  STARTED
  PENDING
  CANCELLED
  FINISH
}

enum StatePayment {
  PAID
  PENDING
  CANCELLED
}

model User {
  id                 Int         @id @default(autoincrement())
  name               String
  lastname           String
  dni                String      @unique
  email              String      @unique
  password           String
  phone_number       Int         @unique
  address            String
  postal_code        Int
  rol                Role        @default(CLIENT)
  account_verified   Boolean     @default(false)
  cars               Car[]
  date_register      DateTime
  servicesAsClient   Appoiment[] @relation("ClientRelation")
  servicesAsMechanic Appoiment[] @relation("MechanicRelation")
}

model Car {
  id              Int         @id @default(autoincrement())
  photo           String
  brand           String
  model           String
  enrolment       String      @unique // Matricula
  chassis_number  String      @unique // Numero de bastidor
  last_revision   DateTime?
  current_mileage Int
  engine          String
  owner           User        @relation(fields: [ownerId], references: [id])
  ownerId         Int
  services        Appoiment[]
}

model Service {
  id             Int                @id @default(autoincrement())
  name           String
  description    String
  price          Int
  frequency_km   Int // Cada cuantos km realizar este servicio
  frequency_time String // Cada cierto tiempo realizar el servicio
  duration       String // En horas
  services       AppoimentService[]
  parts          PartsService[]
}

model Appoiment {
  id                  Int                @id @default(autoincrement())
  state               StateServie
  client              User               @relation("ClientRelation", fields: [clientId], references: [id])
  clientId            Int
  car                 Car                @relation(fields: [carId], references: [id])
  carId               Int
  services            AppoimentService[]
  mechanic            User               @relation("MechanicRelation", fields: [mechanicId], references: [id])
  mechanicId          Int
  appoiment_date      DateTime
  mileage_at_delivery Int               @default(0)
  invoice             Invoice[]
}

model AppoimentService {
  id           Int                    @id @default(autoincrement())
  appoiment    Appoiment              @relation(fields: [id_appoiment], references: [id])
  id_appoiment Int
  services     Service                @relation(fields: [id_service], references: [id])
  id_service   Int
  parts_used   AppoimentServicePart[]
}

model Parts {
  id             Int                    @id @default(autoincrement())
  name           String
  reference      String
  price          Int
  stock          Int                    @default(0)
  frequency_km   Int  @default(0)
  frequency_time String @default("")
  typeServices   PartsService[]
  usedInServices AppoimentServicePart[]
}

// Este modelo se usa para indicar que piezas se usan en los tipos de servicio
model PartsService {
  id               Int     @id @default(autoincrement())
  part             Parts   @relation(fields: [partId], references: [id])
  partId           Int
  typeService      Service @relation(fields: [typeServiceId], references: [id])
  typeServiceId    Int
  quantity         Int // cantidad de piezas que se tienen que cambiar
  changeRecomended Boolean // para indicar si la pieza es recomendable de cambiar o no dependiendo del tiempo y km del coche
}

model AppoimentServicePart {
  id                 Int              @id @default(autoincrement())
  appoimentService   AppoimentService @relation(fields: [appoimentServiceId], references: [id])
  appoimentServiceId Int
  part               Parts            @relation(fields: [partId], references: [id])
  partId             Int
  quantity           Int
  replaced           Boolean
}

model Invoice {
  id             Int          @id @default(autoincrement())
  appoiment      Appoiment    @relation(fields: [id_appoiment], references: [id])
  id_appoiment   Int
  total_cost     Int
  date_entered   DateTime
  departure_date DateTime
  state          StatePayment
  notes          String
}
